<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= lesson.title %></title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/secure-player.css">

  <!-- Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ¯ -->
  <style>
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>

  <!-- Ù…Ù†Ø¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± -->
  <script>
    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„ÙŠÙ…ÙŠÙ†
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    });

    // Ù…Ù†Ø¹ Ù…ÙØ§ØªÙŠØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
    document.addEventListener('keydown', function(e) {
      // F12
      if (e.keyCode === 123) {
        e.preventDefault();
        return false;
      }

      // Ctrl+Shift+I / Cmd+Option+I
      if ((e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
          (e.metaKey && e.altKey && e.keyCode === 73)) {
        e.preventDefault();
        return false;
      }

      // Ctrl+Shift+J / Cmd+Option+J
      if ((e.ctrlKey && e.shiftKey && e.keyCode === 74) ||
          (e.metaKey && e.altKey && e.keyCode === 74)) {
        e.preventDefault();
        return false;
      }

      // Ctrl+Shift+C / Cmd+Option+C
      if ((e.ctrlKey && e.shiftKey && e.keyCode === 67) ||
          (e.metaKey && e.altKey && e.keyCode === 67)) {
        e.preventDefault();
        return false;
      }

      // Ctrl+U / Cmd+U
      if ((e.ctrlKey && e.keyCode === 85) ||
          (e.metaKey && e.keyCode === 85)) {
        e.preventDefault();
        return false;
      }
    });

    // ÙƒØ´Ù Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
    let devToolsOpened = false;

    function detectDevTools() {
      const widthThreshold = window.outerWidth - window.innerWidth > 160;
      const heightThreshold = window.outerHeight - window.innerHeight > 160;

      if (widthThreshold || heightThreshold) {
        if (!devToolsOpened) {
          devToolsOpened = true;
          alert('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±. Ù‡Ø°Ø§ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡.');

          // Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø¹Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ø§Ø¹Ø¨
          navigator.sendBeacon('/student/security/tamper-attempt', JSON.stringify({
            reason: 'DevTools detected',
            timestamp: new Date().toISOString(),
            url: window.location.href
          }));
        }
      } else {
        devToolsOpened = false;
      }
    }

    // ÙØ­Øµ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
    setInterval(detectDevTools, 1000);
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Cairo', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a202c, #2d3748);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background-color: rgba(45, 55, 72, 0.9);
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 20px;
      color: #fbbf24;
    }

    .header .student-info {
      display: flex;
      align-items: center;
    }

    .header .student-info span {
      margin-left: 10px;
      font-size: 14px;
      color: #a0aec0;
    }

    .header .student-info strong {
      color: white;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
    }

    .video-container {
      background-color: rgba(45, 55, 72, 0.8);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .video-info {
      padding: 25px;
      background-color: rgba(45, 55, 72, 0.8);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .video-title {
      font-size: 24px;
      color: #fbbf24;
      margin-bottom: 10px;
    }

    .video-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .video-meta-item {
      background-color: rgba(74, 85, 104, 0.5);
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 14px;
      color: #e2e8f0;
    }

    .video-description-container {
      margin-bottom: 20px;
      background-color: rgba(26, 32, 44, 0.3);
      padding: 15px;
      border-radius: 8px;
      border-right: 3px solid #fbbf24;
    }

    .video-description-title {
      color: #fbbf24;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .video-description {
      color: #e2e8f0;
      line-height: 1.6;
    }

    .video-source {
      margin-bottom: 20px;
      background-color: rgba(26, 32, 44, 0.3);
      padding: 15px;
      border-radius: 8px;
      border-right: 3px solid #3182ce;
    }

    .video-source-title {
      color: #3182ce;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .video-source-link {
      color: #90cdf4;
      word-break: break-all;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .video-source-link:hover {
      color: #63b3ed;
      text-decoration: underline;
    }

    .video-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .video-btn {
      background-color: #4a5568;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .video-btn:hover {
      background-color: #2d3748;
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .back-btn {
      background-color: #fbbf24;
      color: #1a202c;
      font-weight: bold;
    }

    .back-btn:hover {
      background-color: #f59e0b;
    }

    .pdf-btn {
      background-color: #e53e3e;
    }

    .pdf-btn:hover {
      background-color: #c53030;
    }

    .exam-btn {
      background-color: #38a169;
    }

    .exam-btn:hover {
      background-color: #2f855a;
    }

    /* ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£Ù†Ù…Ø§Ø· Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù…Ù„Ù CSS Ø®Ø§Ø±Ø¬ÙŠ */

    @media (max-width: 768px) {
      .header h1 {
        font-size: 18px;
      }

      .video-title {
        font-size: 20px;
      }

      .video-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¬ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¯Ø±Ø³</h1>
    <div class="student-info">
      <span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <strong><%= studentName %></strong></span>
    </div>
  </div>

  <div class="container">
    <div class="video-container">
      <!-- Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¢Ù…Ù† -->
      <div id="secureVideoPlayer" class="secure-player-container"></div>
    </div>

    <div class="video-info">
      <h2 class="video-title"><%= lesson.title %></h2>
      <div class="video-meta">
        <%
          let gradeText = '';
          if (lesson.grade === 1) gradeText = 'Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ';
          else if (lesson.grade === 2) gradeText = 'Ø«Ø§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ';
          else if (lesson.grade === 3) gradeText = 'Ø«Ø§Ù„Ø«Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ';
          else if (lesson.grade === 4) gradeText = 'Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ';
          else if (lesson.grade === 5) gradeText = 'Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ';
          else if (lesson.grade === 6) gradeText = 'Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ';
          else gradeText = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„';
        %>
        <span class="video-meta-item">ğŸ“š Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: <%= lesson.grade %></span>
        <span class="video-meta-item">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø±Ø³: <%= lesson.id %></span>
        <span class="video-meta-item">ğŸ“‚ Ø§Ù„Ø´Ù‡Ø±: <%= lesson.monthId %></span>
      </div>

      <div class="video-description-container">
        <h3 class="video-description-title">ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³:</h3>
        <p class="video-description"><%= lesson.description %></p>
      </div>

      <% if (lesson.url) { %>
        <div class="video-source">
          <h3 class="video-source-title">Ù…ØµØ¯Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:</h3>
          <a href="<%= lesson.url %>" target="_blank" class="video-source-link"><%= lesson.url %></a>
        </div>
      <% } %>

      <div class="video-actions">
        <a href="/student/months/<%= lesson.monthId %>" class="video-btn back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø±</a>

        <% if (lesson.pdf && lesson.pdf.trim() !== '') { %>
          <a href="/student/download-pdf/<%= lesson.id %>" class="video-btn pdf-btn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ğŸ“„</a>
        <% } %>

        <% if (lesson.exams && lesson.exams.trim() !== '') { %>
          <a href="/student/take-exam/<%= lesson.id %>" class="video-btn exam-btn">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸ“</a>
        <% } %>
      </div>
    </div>
  </div>
  <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØªØ´ÙˆÙŠØ´ Ø§Ù„ÙƒÙˆØ¯ -->
  <script src="/js/crypto-utils.js"></script>
  <script src="/js/obfuscator.js"></script>
  <script src="/js/secure-player.js"></script>

  <!-- ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© -->
  <script>
    // ØªØ´ÙˆÙŠØ´ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙ„Ø§Ø¹Ø¨
    (function() {
      // Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø´ÙØ±Ø©
      const _0x5f8e9d = Math.random().toString(36).substring(2, 15);
      const _0x3c2b1a = { secure: true, key: window.location.hostname };
      const _0x7f8e9d = new Date().getTime();

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¢Ù…Ù†
      document.addEventListener('DOMContentLoaded', function() {
        try {
          // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
          const player = new SecureVideoPlayer('secureVideoPlayer');

          // ØªØ®Ø²ÙŠÙ† Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø´ØºÙ„ ÙÙŠ Ù…ØªØºÙŠØ± Ù…Ø®ÙÙŠ
          window['_' + _0x5f8e9d] = player;

          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
          player.loadVideo(<%= lesson.id %>);

          // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
          window.addEventListener('beforeunload', function() {
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…Ø´ØºÙ„ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
            if (player && typeof player.destroy === 'function') {
              player.destroy();
            }

            // Ù…Ø³Ø­ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            window['_' + _0x5f8e9d] = null;
          });

          // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨
          document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
              // ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
              navigator.sendBeacon('/student/security/tamper-attempt', JSON.stringify({
                reason: 'Tab switched',
                timestamp: new Date().toISOString(),
                url: window.location.href
              }));
            }
          });

          // Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø®
          document.addEventListener('copy', function(e) {
            e.preventDefault();
            return false;
          });

          // Ù…Ù†Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
          window.addEventListener('beforeprint', function(e) {
            e.preventDefault();
            alert('Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§');
            return false;
          });
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´ØºÙ„:', error);
        }
      });

      // ÙƒÙˆØ¯ Ù…Ø¶Ø§Ø¯ Ù„Ù„ØªØµØ­ÙŠØ­
      setInterval(function() {
        const start = new Date();
        debugger;
        const end = new Date();
        if (end - start > 100) {
          // ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ„Ø§Ø¹Ø¨
          navigator.sendBeacon('/student/security/tamper-attempt', JSON.stringify({
            reason: 'Debugger detected',
            timestamp: new Date().toISOString(),
            url: window.location.href
          }));
        }
      }, 1000);
    })();
  </script>

  <!-- Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø® Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± -->
  <script>
    // ØªØ¹Ø·ÙŠÙ„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø³Ø®
    Object.defineProperty(window, 'clipboardData', {
      get: function() {
        return {
          setData: function() {
            return false;
          },
          getData: function() {
            return '';
          }
        };
      }
    });
  </script>
</body>
</html>
