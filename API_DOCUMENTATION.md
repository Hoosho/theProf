# توثيق واجهة برمجة التطبيقات (API) لمنصة The Prof

## مقدمة

هذا المستند يوثق واجهة برمجة التطبيقات (API) لمنصة The Prof التعليمية. يتضمن المستند تفاصيل حول نقاط النهاية المتاحة، طرق الطلب، المعلمات المطلوبة، وأمثلة للاستجابات.

## الأساسيات

### عنوان الخادم الأساسي
```
http://localhost:5000
```

### التوثيق
تستخدم المنصة توثيق JWT (JSON Web Token) المخزن في ملفات تعريف الارتباط (cookies). يجب إرسال رمز JWT في كل طلب يتطلب توثيقاً.

### تنسيق الاستجابة
جميع الاستجابات تكون بتنسيق JSON ما لم يُذكر خلاف ذلك.

## نقاط النهاية للمصادقة

### تسجيل الدخول
- **طريقة الطلب**: POST
- **المسار**: `/auth/login`
- **الوصف**: تسجيل دخول المستخدم والحصول على رمز JWT
- **المعلمات**:
  ```json
  {
    "studentNumber": "112233",
    "password": "password123"
  }
  ```
- **الاستجابة الناجحة**:
  ```json
  {
    "success": true,
    "message": "تم تسجيل الدخول بنجاح",
    "user": {
      "_id": "681ed63e9dbd37ea68cc680c",
      "studentName": "أحمد علي",
      "studentNumber": "112233",
      "studentGrade": "2prep",
      "role": "student"
    }
  }
  ```

### تسجيل الخروج
- **طريقة الطلب**: GET
- **المسار**: `/auth/logout`
- **الوصف**: تسجيل خروج المستخدم وإزالة رمز JWT
- **الاستجابة الناجحة**:
  ```json
  {
    "success": true,
    "message": "تم تسجيل الخروج بنجاح"
  }
  ```

## نقاط النهاية للطالب

### الحصول على الشهور المتاحة
- **طريقة الطلب**: GET
- **المسار**: `/student/months`
- **الوصف**: الحصول على قائمة الشهور المتاحة للطالب
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **الاستجابة الناجحة**:
  ```json
  {
    "months": [
      {
        "id": 1,
        "name": "شهر مارس",
        "grade": 1,
        "pricOfMonth": 100,
        "isBought": true
      },
      {
        "id": 2,
        "name": "شهر ابريل",
        "grade": 2,
        "pricOfMonth": 150,
        "isBought": false
      }
    ]
  }
  ```

### الحصول على تفاصيل الشهر
- **طريقة الطلب**: GET
- **المسار**: `/student/months/:id`
- **الوصف**: الحصول على تفاصيل شهر محدد والدروس المرتبطة به
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **معلمات المسار**:
  - `id`: معرف الشهر
- **الاستجابة الناجحة**:
  ```json
  {
    "month": {
      "id": 1,
      "name": "شهر مارس",
      "grade": 1,
      "pricOfMonth": 100,
      "isBought": true
    },
    "classes": [
      {
        "id": 1,
        "title": "الدرس الأول في الرياضيات",
        "description": "شرح أساسيات الرياضيات",
        "grade": 1,
        "monthId": 1
      }
    ]
  }
  ```

### شراء شهر
- **طريقة الطلب**: POST
- **المسار**: `/student/buy-month/:id`
- **الوصف**: شراء شهر محدد
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **معلمات المسار**:
  - `id`: معرف الشهر
- **الاستجابة الناجحة**:
  ```json
  {
    "success": true,
    "message": "تم شراء الشهر بنجاح",
    "month": {
      "id": 2,
      "name": "شهر ابريل",
      "grade": 2,
      "pricOfMonth": 150,
      "purchaseDate": "2023-06-15T10:30:00.000Z"
    }
  }
  ```

### تدفق الفيديو الآمن
- **طريقة الطلب**: GET
- **المسار**: `/student/video-stream/:id`
- **الوصف**: الحصول على معلومات الفيديو المشفرة
- **الرؤوس المطلوبة**: 
  - رمز JWT في ملف تعريف الارتباط
  - `X-Request-Timestamp`: الطابع الزمني للطلب
  - `X-Session-ID`: معرف الجلسة
  - `X-Client-Signature`: توقيع العميل
- **معلمات المسار**:
  - `id`: معرف الدرس
- **الاستجابة الناجحة**:
  ```json
  {
    "sessionToken": "a1b2c3d4e5f6g7h8i9j0",
    "timestamp": 1623751234567,
    "signature": "abcdef1234567890abcdef1234567890",
    "studentId": "681ed63e9dbd37ea68cc680c",
    "lessonId": 1,
    "type": "youtube",
    "data": "iv:encryptedData",
    "lessonInfo": {
      "title": "الدرس الأول في الرياضيات",
      "description": "شرح أساسيات الرياضيات",
      "grade": 1,
      "monthId": 1
    }
  }
  ```

### مشاهدة الفيديو
- **طريقة الطلب**: GET
- **المسار**: `/student/watch-video/:id`
- **الوصف**: عرض صفحة مشاهدة الفيديو
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **معلمات المسار**:
  - `id`: معرف الدرس
- **الاستجابة الناجحة**: صفحة HTML

### تحميل الملف
- **طريقة الطلب**: GET
- **المسار**: `/student/download-pdf/:id`
- **الوصف**: تحميل ملف PDF للدرس
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **معلمات المسار**:
  - `id`: معرف الدرس
- **الاستجابة الناجحة**: إعادة توجيه إلى رابط الملف

### الامتحان
- **طريقة الطلب**: GET
- **المسار**: `/student/take-exam/:id`
- **الوصف**: الوصول إلى امتحان الدرس
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **معلمات المسار**:
  - `id`: معرف الدرس
- **الاستجابة الناجحة**: إعادة توجيه إلى رابط الامتحان

### تسجيل محاولات التلاعب
- **طريقة الطلب**: POST
- **المسار**: `/student/security/tamper-attempt`
- **الوصف**: تسجيل محاولات التلاعب بالمحتوى
- **المعلمات**:
  ```json
  {
    "reason": "DevTools detected",
    "timestamp": "2023-06-15T10:30:00.000Z",
    "sessionId": "a1b2c3d4e5f6g7h8i9j0",
    "url": "http://localhost:5000/student/watch-video/1"
  }
  ```
- **الاستجابة الناجحة**: رمز الحالة 204 (بدون محتوى)

## نقاط النهاية للمعلم

### إضافة طالب
- **طريقة الطلب**: POST
- **المسار**: `/teacher/add-student`
- **الوصف**: إضافة طالب جديد
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **المعلمات**:
  ```json
  {
    "studentName": "محمد أحمد",
    "studentNumber": "778899",
    "studentGrade": "3prep",
    "password": "password123"
  }
  ```
- **الاستجابة الناجحة**:
  ```json
  {
    "success": true,
    "message": "تم إضافة الطالب بنجاح",
    "student": {
      "_id": "681ed63e9dbd37ea68cc6820",
      "studentName": "محمد أحمد",
      "studentNumber": "778899",
      "studentGrade": "3prep"
    }
  }
  ```

### إضافة شهر
- **طريقة الطلب**: POST
- **المسار**: `/teacher/add-month`
- **الوصف**: إضافة شهر جديد
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **المعلمات**:
  ```json
  {
    "name": "شهر يوليو",
    "grade": 3,
    "pricOfMonth": 200
  }
  ```
- **الاستجابة الناجحة**:
  ```json
  {
    "success": true,
    "message": "تم إضافة الشهر بنجاح",
    "month": {
      "id": 5,
      "name": "شهر يوليو",
      "grade": 3,
      "pricOfMonth": 200
    }
  }
  ```

### إضافة درس
- **طريقة الطلب**: POST
- **المسار**: `/teacher/add-class`
- **الوصف**: إضافة درس جديد
- **الرؤوس المطلوبة**: رمز JWT في ملف تعريف الارتباط
- **المعلمات**:
  ```json
  {
    "title": "الدرس الثالث في الرياضيات",
    "description": "شرح المصفوفات",
    "grade": 3,
    "monthId": 3,
    "url": "https://youtu.be/example",
    "pdf": "https://example.com/math_lesson3.pdf",
    "exams": "https://example.com/math_exam3.pdf"
  }
  ```
- **الاستجابة الناجحة**:
  ```json
  {
    "success": true,
    "message": "تم إضافة الدرس بنجاح",
    "class": {
      "id": 5,
      "title": "الدرس الثالث في الرياضيات",
      "description": "شرح المصفوفات",
      "grade": 3,
      "monthId": 3,
      "url": "https://youtu.be/example",
      "pdf": "https://example.com/math_lesson3.pdf",
      "exams": "https://example.com/math_exam3.pdf"
    }
  }
  ```

## رموز الخطأ الشائعة

- **400 Bad Request**: طلب غير صالح
- **401 Unauthorized**: غير مصرح بالوصول (عدم وجود رمز JWT)
- **403 Forbidden**: ممنوع الوصول (رمز JWT صالح ولكن غير مصرح بالوصول)
- **404 Not Found**: لم يتم العثور على المورد
- **500 Internal Server Error**: خطأ داخلي في الخادم

## ملاحظات أمنية

1. جميع طلبات API تتطلب HTTPS في بيئة الإنتاج
2. رموز JWT تنتهي صلاحيتها بعد 24 ساعة
3. يتم تشفير جميع بيانات الفيديو قبل إرسالها إلى العميل
4. يتم تسجيل جميع محاولات التلاعب بالمحتوى
5. يتم استخدام آليات متعددة لمنع الوصول غير المصرح به إلى المحتوى
